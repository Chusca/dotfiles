#!/bin/bash

# .tool-versions hash: {{ include "dot_tool-versions" | sha256sum }}

#Install tool-versions if needed
source "${HOME}/.asdf/asdf.sh"
echo "Installing tools from .tool-versions"
tool_versions_content="{{ include "dot_tool-versions" }}"
while IFS= read -r line || [ -n "$line" ]; do
    #Split line into tool and version
    tool=$(echo "$line" | cut -d ' ' -f 1)
    version=$(echo "$line" | cut -d ' ' -f 2)
    echo "Found tool '$tool' with version '$version'"
    if [ "$version" == "system" ]; then
        echo "Skipping '$tool' as version is 'system'"
        continue
    fi
    echo "Updating '$tool' plugin"
    if ! asdf plugin update "$tool"; then
        echo "Adding '$tool' plugin"
        asdf plugin add "$tool"
    fi
    echo "Installing '$tool $version'"
    if ! asdf install "$tool" "$version"; then
        echo "Failed to install '$version' for '$tool'"
    fi
done <<< "$tool_versions_content"
